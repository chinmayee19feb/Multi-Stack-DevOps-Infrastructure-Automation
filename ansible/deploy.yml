# ============================================================
# Multi-AZ Deployment Playbook
# - Frontend: vote (Flask) & result (Node.js) in both AZs
# - Backend: redis & worker (.NET) in both AZs  
# - Database: postgres (PostgreSQL) in both AZs
# ============================================================

# ------------------------------------------------------------
# PLAY 1: Setup all servers (common prerequisites)
# ------------------------------------------------------------
- name: Setup all servers (common prerequisites)
  hosts: all
  become: yes

  tasks:
    - name: Ensure python3-pip is installed
      dnf:
        name: python3-pip
        state: present

    - name: Install Docker
      dnf:
        name: docker
        state: present

    - name: Ensure docker service is started
      systemd:
        name: docker
        state: started
        enabled: yes

# ------------------------------------------------------------
# PLAY 2: FRONTEND - Public-facing services (vote & result)
# ------------------------------------------------------------
- name: Setup frontend
  hosts: frontend
  become: yes
  vars:
    # Dynamic configuration based on AZ
    backend_ip: "{{ '10.20.2.210' if '10.20.1' in ansible_host else '10.20.5.134' }}"
    db_ip: "{{ '10.20.3.182' if '10.20.1' in ansible_host else '10.20.6.150' }}"

  tasks:
    - name: Pull vote image
      community.docker.docker_image:
        name: chinmayee606/vote
        tag: latest
        source: pull

    - name: Run vote app
      community.docker.docker_container:
        name: vote-{{ inventory_hostname | regex_replace('[^a-zA-Z0-9]', '') }}
        image: chinmayee606/vote:latest
        published_ports:
          - "8080:80"
        env:
          REDIS_HOST: "{{ backend_ip }}"
        restart_policy: always
        state: started

    - name: Pull result image
      community.docker.docker_image:
        name: chinmayee606/result
        tag: latest
        source: pull

    - name: Run result app
      community.docker.docker_container:
        name: result-{{ inventory_hostname | regex_replace('[^a-zA-Z0-9]', '') }}
        image: chinmayee606/result:latest
        published_ports:
          - "8081:80"
        env:
          PG_HOST: "{{ db_ip }}"
          PG_USER: "postgres"
          PG_PASSWORD: "postgres"
          PG_DATABASE: "postgres"
        restart_policy: always
        state: started

# ------------------------------------------------------------
# PLAY 3: BACKEND - Internal services (Redis + Worker)
# ------------------------------------------------------------
- name: Setup backend
  hosts: backend
  become: yes
  vars:
    db_ip: "{{ '10.20.3.182' if '10.20.2' in ansible_host else '10.20.6.150' }}"

  tasks:
    - name: Create backend Docker network
      community.docker.docker_network:
        name: backend-net-{{ inventory_hostname | regex_replace('[^a-zA-Z0-9]', '') }}
        driver: bridge

    - name: Pull redis image
      community.docker.docker_image:
        name: redis
        tag: alpine
        source: pull

    - name: Run redis
      community.docker.docker_container:
        name: redis-{{ inventory_hostname | regex_replace('[^a-zA-Z0-9]', '') }}
        image: redis:alpine
        command: redis-server --bind 0.0.0.0
        published_ports:
          - "6379:6379"
        networks:
          - name: backend-net-{{ inventory_hostname | regex_replace('[^a-zA-Z0-9]', '') }}
        restart_policy: always
        state: started

    - name: Pull worker image
      community.docker.docker_image:
        name: chinmayee606/worker
        tag: latest
        source: pull

    - name: Run worker service
      community.docker.docker_container:
        name: worker-{{ inventory_hostname | regex_replace('[^a-zA-Z0-9]', '') }}
        image: chinmayee606/worker:latest
        networks:
          - name: backend-net-{{ inventory_hostname | regex_replace('[^a-zA-Z0-9]', '') }}
        env:
          REDIS_HOST: "redis-{{ inventory_hostname | regex_replace('[^a-zA-Z0-9]', '') }}"
          DB_HOST: "{{ db_ip }}"
          DB_USERNAME: "postgres"
          DB_PASSWORD: "postgres"
          DB_NAME: "postgres"
        restart_policy: always
        state: started

# ------------------------------------------------------------
# PLAY 4: DATABASE - PostgreSQL
# ------------------------------------------------------------
- name: Setup database
  hosts: db
  become: yes

  tasks:
    - name: Ensure docker volume for Postgres exists
      community.docker.docker_volume:
        name: pgdata-{{ inventory_hostname | regex_replace('[^a-zA-Z0-9]', '') }}
        state: present

    - name: Pull postgres image
      community.docker.docker_image:
        name: postgres
        tag: "15-alpine"
        source: pull

    - name: Run postgres
      community.docker.docker_container:
        name: postgres-{{ inventory_hostname | regex_replace('[^a-zA-Z0-9]', '') }}
        image: postgres:15-alpine
        env:
          POSTGRES_USER: "postgres"
          POSTGRES_PASSWORD: "postgres"
        volumes:
          - pgdata-{{ inventory_hostname | regex_replace('[^a-zA-Z0-9]', '') }}:/var/lib/postgresql/data
        published_ports:
          - "5432:5432"
        restart_policy: always
        state: started